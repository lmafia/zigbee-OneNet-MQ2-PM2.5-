KISSY.add("tbc/sku/1.0.12/mods/track",function(a,b,c){function d(a){return d.superclass.constructor.call(this,a),this}return a.augment(d,{send:function(b){var d=this,e=d.get("startTime"),f={ua:navigator.userAgent,msg:"",nick:"",file:"",line:0,delay:+new Date-e,screen:screen.width+"x"+screen.height,scrolltop:document.documentElement&&document.documentElement.scrollTop||document.body&&document.body.scrollTop||0,url:"//item.taobao.com/track/",category:"",sampling:1e3};if(b=a.merge(f,b),7===parseInt(Math.random()*b.sampling)){try{var g=/_nk_=([^;]+)/.exec(document.cookie);g&&(b.nick=g[1])}catch(h){}b.msg=["[u"+b.url+"]","[t"+b.delay+"]","[c"+b.category+"]","[r"+b.sampling+"]"].join("")+(a.isObject(b.msg)?c.stringify(b.msg):b.msg),d.sendImage("//gm.mmstat.com/ued.1.1.2?"+["type=9","id=jstracker","v=0.02","ua="+encodeURIComponent(b.ua),"msg="+encodeURIComponent(b.msg),"nick="+decodeURIComponent(b.nick),"file="+encodeURIComponent(b.file),"line="+b.line,"screen="+b.screen,"scrolltop="+b.scrolltop,"t="+(new Date).valueOf()].join("&"))}},sendImage:function(a){var b="_img_"+ +new Date,c=window[b]=new Image;c.onload=c.onerror=function(){window[b]=null},c.src=a,c=null}}),a.extend(d,b),d.ATTRS={startTime:{value:window.g_config&&window.g_config.startTime||+new Date}},d},{requires:["base","json"]}),KISSY.add("tbc/sku/1.0.12/index",function(a,b,c,d){function e(a){return e.superclass.constructor.call(this,a),this}var f=b.all;return a.augment(e,{init:function(){var a=this,b=new d;b.send();try{a.getPropertyIds(),a.normalizeSkuMap(),a.serializeSkuMap(),a.getSkuMapConfig(),a.bind()}catch(c){b.send({msg:{url:location.href,err:c},category:"sku:init:false"})}},bind:function(){var b=this,c=b.get("root"),d=b.get("hook"),e=b.get("attrName"),g=b.get("selectedClass"),h=b.get("disabledClass"),i=f(d,c),j=function(){var c=[],d=b.get("props");return a.each(d,function(a){a&&c.push(a[0])}),f(c)},k=function(a){var b=[];return a.each(function(a){a=f(a),b.push(a.attr(e))}),b};f(c).delegate("click",d,function(c){var d=f(c.currentTarget),l=d.attr(e),m=l&&l.split(":")[0],n=b.get("props"),o=b.get("serializedSkuMap");if(c.halt(),m&&!d.hasClass(h)){d.hasClass(g)?n[m]=null:n[m]=d,d.toggleClass(g).siblings().removeClass(g);var p=j(),q=[];p.length?(q=k(p),q=b.sortPropertyId(q),i.each(function(c){c=f(c);var i,j,k=[];a.inArray(c[0],p)||c[0]===d[0]||(i=c.siblings("."+g),i.length?(j=i.attr(e),a.each(q,function(a){a!==j&&k.push(a)})):k=q,k=k.concat(c.attr(e)),k=b.sortPropertyId(k),o[k.join(";")]?c.removeClass(h):c.addClass(h).removeClass(g))})):i.each(function(a){a=f(a),o[a.attr(e)]?a.removeClass(h):a.addClass(h).removeClass(g)}),b.fireCustomEvent(d,p,q)}}),i.each(function(a){a=f(a),0===a.siblings().length&&a.fire("click")})},getPropertyIds:function(){var a=this,b=a.get("root"),c=a.get("hook"),d=a.get("attrName"),e={};f(c,b).each(function(a){a=f(a);var b=a.attr(d);if(b){var c=b.split(":")[0];!c||c in e||(e[c]=null)}}),a.set("props",e)},sortPropertyId:function(a){return a.sort(function(a,b){return parseInt(a)-parseInt(b)}),a},mixDynamicPromo:function(b,c){return c&&!a.isEmptyObject(c)&&a.each(c,function(c,d){var e=b[d];e&&c.length&&(c[0].price&&(e.priceDefault=e.price),a.mix(e,c[0]),e.limit=c[0].amountRestriction)}),b},mixDynamicStock:function(b,c){var d=this,e=d.get("root"),g=d.get("hook"),h=d.get("attrName"),i=f(g,e),j={};return c&&!a.isEmptyObject(c)&&(a.each(b,function(d,e){var f=c[e];if(f&&f.stock){var g=e.split(";");a.each(g,function(a){j[a]=!0}),b[e].stock=f.stock,b[e].oversold=f.oversold}else delete b[e]}),i.each(function(a){a=f(a);var b=a.attr(h);b&&!j[b]&&a.remove()})),b},hasSku:function(){var b=this,c=b.get("skuMap");return c&&!a.isEmptyObject(c)},hasPromo:function(){var a=this,b=a.getDefaultPromo();return!(!b||!b.price)},isOverSold:function(){var a=this,b=a.getCurrentSku(),c=a.getDefaultStock();return c&&"0"===c.virtQuantity?!0:b&&"true"===b.oversold?!0:!1},setCurrentSku:function(b){var c=this,d=c.get("root"),e=c.get("hook"),g=c.get("attrName"),h=c.get("selectedClass"),i=c.get("disabledClass"),j=f(e,d),k=b.pvs;a.isString(k)&&(j.each(function(a){a=f(a),a.hasClass(h)&&a.fire("click")}),j.removeClass(i),c.getPropertyIds(),j.each(function(a){a=f(a);var b=a.attr(g);~k.indexOf(b)&&a.fire("click")}))},getCurrentSku:function(){var a=this;return a.get("sku")},getDefaultPromo:function(){var a,b=this,c=b.get("promoMap"),d=c.def;return d&&d.length&&(d=d[0],a={type:d.type,price:d.price,limit:d.amountRestriction,isStart:d.isStart,limitTime:d.limitTime}),a},getDefaultStock:function(){var a,b=this,c=b.get("stockMap");return c&&(a={stock:c.stock,virtQuantity:c.virtQuantity}),a},normalizeSkuMap:function(){var b=this,c=b.get("skuMap"),d=b.get("promoMap"),e=b.get("stockMap")&&b.get("stockMap").sku,f=function(b){var c={};return a.each(b,function(a,b){var d;b=b.replace(/^;|;$/gi,""),d=b.split(";"),d.sort(function(a,b){return parseInt(a)-parseInt(b)}),c[d.join(";")]=a}),c};c=f(c),d=f(d),e=f(e),c=b.mixDynamicPromo(c,d),c=b.mixDynamicStock(c,e),b.set("skuMap",c)},serializeSkuMap:function(){var b=this,c=b.get("skuMap"),d={},e=function(b,c){var d=[];if(c===b.length)return[b];if(1===c)a.each(b,function(a){d.push([a])});else for(var f=0;f<=b.length-c;f++){var g=b.slice(f,f+1),h=b.slice(f+1);a.each(e(h,c-1),function(a){d.push(g.concat(a))})}return d};a.each(c,function(b,c){for(var f=c.split(";"),g=b.stock,h=b.price,i=[],j=1;j<=f.length;j++)i=i.concat(e(f,j));g=parseInt(g),a.each(i,function(a){var b=a.join(";"),c=d[b];c?(c.stock+=g,c.prices.push(h)):d[b]={stock:g,prices:[h]}})}),b.set("serializedSkuMap",d)},getSkuMapConfig:function(){var b=this,c=b.get("skuMap");a.each(c,function(a,c){return b.set("length",c.split(";").length),!1})},fireCustomEvent:function(b,c,d){var e=this,f=e.get("props"),g=e.get("length"),h=e.get("lastSelectedLength"),i=e.get("skuMap"),j=d.length,k={el:b,els:c,pvs:d.join(";"),props:f};if(e.fire("selectionChanged",{sku:k}),j===g){var l,m=d.join(";"),n=i[m];n=a.merge(n,k),l=h===g?"skuChanged":"skuFound",e.set("sku",n),e.fire(l,{sku:n})}else e.set("sku",null),h===g&&e.fire("skuLost",null);e.set("lastSelectedLength",j)}}),a.extend(e,c),e.ATTRS={root:{value:"#J_SKU"},hook:{value:".J_SKU"},skuMap:{value:{},getter:function(b){return a.clone(b)}},serializedSkuMap:{value:{}},promoMap:{value:{}},stockMap:{value:{}},attrName:{value:"data-pv"},selectedClass:{value:"tb-selected"},disabledClass:{value:"tb-disabled"},sku:{},props:{},length:{},lastSelectedLength:{value:0}},e},{requires:["node","base","./mods/track"]});