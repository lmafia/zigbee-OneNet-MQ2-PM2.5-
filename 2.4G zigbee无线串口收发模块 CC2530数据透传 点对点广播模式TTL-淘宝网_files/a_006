KISSY.add("tbc/search-suggest/1.4.7/index",function(e,t,r,n,o,a,i,u,s){var l=(t.all,r.extend([],{initializer:function(){var e=this;e._initCombo(),e.bindUtil()},bindUtil:function(){var e=this;e.Utils=new u,e.Stat=new s},_setComboCache:function(e){var t=this,r=t.get("tab");t.configArr=t.configArr||[],t.configArr[r]={data:e}},_checkHasTab:function(){var e=this,t=e.getPlugin("tab");t||(e.tabNode=e.get("form"))},_initComboEvent:function(){var t=this,r=t.comboBox,o=r.get("input");o.on("mousedown",function(n){if(t.fire("beforeFocus")!==!1){var a=e.trim(o.val()),i=t.get("sugConfig"),u=!0;u&&(i.autoCollapsed||""===a)&&r.sendRequest(a)}n.stopPropagation()}),o.on("focus",function(){t.fire("beforeFocus")}),o.on("blur",function(){return t.fire("beforeBlur")===!1?!1:void 0});var a=t.get("sugConfig").itemClick,i=!0;if(a&&e.isFunction(a)){i=!1;var u=a.apply(this,arguments);u!==!1&&(i=!0)}i&&r.on("click",t.comboClick,t),r.on("afterCollapsedChange",t._addExtraEvent,t),r.on("afterCollapsedChange",function(e){t.fire("afterCollapsedChange",e)}),r.on("beforeQueryChange",function(e){t.fire("beforeQueryChange",e)}),r.on("beforeSetInputValue",function(){var e=t.get("label");e&&n.hide(e)}),t._formSubmitEvent(),t.query=o.val();var s=t.get("label");s&&s.on("click",function(){r.sendRequest(o.val())})},_formSubmitEvent:function(){var t,r=this,n=r.comboBox,o=n.get("input"),a=o.parent("form"),i=n.get("input");a.on("submit",function(n){r.fire("beforeSubmit",{el:a,isInitSearch:!0})!==!1?(t=a.attr("action"),""===e.trim(i.val())&&r._emptyJump(a)===!1&&n.preventDefault(),r.serializeToForm(a,t)):n.halt()})},serializeToForm:function(e,t){var r,n,o,a="",i="";if(t&&e){if(-1===t.indexOf("?"))return;if(a=t.split("?")[1]){r=a.split("&");for(var u in r)n=r[u].split("="),o=n[0],o&&!e[0][o]&&(i+='<input type="hidden" name="'+n[0]+'" value="'+n[1]+'"/>');e.append(i)}}},_defaultPageJump:function(e){var t,r=this,n=r.tabNode;if(!n)return!1;if(t=e.attr("data-defaultpage")||n.attr("data-defaultpage")){if(!/(http(s:|:))?\/\//.test(t))return!1;e.attr("action",t)}},_emptyJump:function(e){{var t,r=this,n=e.one("label"),o=r.get("sugConfig");o.tab}return n?(t=n.one("span"),t&&""!==t.text()?(n.hide(),void r._holderJump(e,t.text())):r._defaultPageJump(e)):r._defaultPageJump(e)},_holderJump:function(e,t){var r=e[0].q;r&&(r.value=t),e.append('<input type="hidden" name="style" value="grid" />')},_sendSnapshot:function(t){for(var r=this,n=[],o=-1,a=0;a<t.children.length;a++){var i=t.children[a];t.selected==i.value?o=a:n.push(i.value+"/"+i.index)}var u="f_stats_show=xialalist:";u+=n.join(","),u=u+";query:"+t.query,u=u+";selected:"+t.selected+"/"+o,u=u+";time:"+e.now(),u=u+";nick:"+r.getNick(),r.Stat.send(u,!0)},comboClick:function(e){var r,n=this,o=e.target.get?e.target.get("el"):t.one(e.currentTarget),a=n.comboBox,i=o.one(".item-text, .search-menu-key, .search-menu-history-key"),u=!1,s=n.get("form"),l=n.get("sugConfig").isSendByForm;if(i){r=i.text();var c=n.historyArr;if(c)for(var f=0,g=c.length-1;g>=f;f++)if(r===c[f]){u=!0;break}}for(var d=a.get("menu"),m=d.get("children"),p=[],f=0;f<m.length;f++){var h=m[f],v=h.get("value");v&&p.push({index:f,value:v[0]})}var b={query:n.query||"",children:p,selected:r||""};if(n._sendSnapshot(b),n.fire("beforeSubmit",{el:o,isInitSearch:!1,isNotSave:u})!==!1){var C=n.getRedirect(o);l?(n.serializeToForm(s,C),s[0].submit()):n.redirect(C)}},getRedirect:function(e){var t=this,r=(t.comboBox,t.query),o=t.query,a=n.children(e),i=n.attr(a,"data-key")||"q="+r,u=t.get("form")[0],s=n.attr(u,"action"),l=n.attr(a,"data-action")||t.get("action")||s,c=n.attr(a,"data-source-stat")||"source=suggest",f="&_input_charset=utf-8&wq="+encodeURIComponent(o)+"&suggest_query="+encodeURIComponent(r)+"&"+c,g=t._getInputsVal(u);return l+=l.indexOf("?")>-1?"&":"?",l+g+"&"+i+f},redirect:function(e){var t=this,r=t.get("sugConfig").isEncode;r?e=t.urlEncode(e):(e=e.replace(/(#)[^!]/g,function(e,t){return e.replace(t,"%23")}),e=e.replace(/#!/g,"#"));var n=document.createElement("a");n.setAttribute("href",e),n.setAttribute("target","_self"),n.style.display="none",document.body.appendChild(n),n.click()},urlEncode:function(t){var r=/[\u4e00-\u9fa5\uf900-\ufa2d+#\s]+/g.exec(t);if(r)try{t=t.replace("？","?"),t=t.replace(/[\u4e00-\u9fa5\uf900-\ufa2d+#]+/g,function(e){return encodeURIComponent(e)}),t=t.replace(/\s/g,function(e){return"+"}),t+="&ie=utf-8"}catch(n){e.log("url编码出错!")}return t},_getInputsVal:function(t){var r,o,a=this,i=a.get("sugConfig"),u=i.excludeParam,s=[];inputs=n.query("input",t);for(var l=inputs.length-1;l>=0;l--)r=inputs[l],o=r.name,o&&!e.inArray(o,u)&&s.push(o+"="+encodeURIComponent(r.value));return s.length<1?"":"&"+s.join("&")},_getDefComboCfg:function(){return{focused:!1,hasTrigger:!1,matchElWidth:!0,srcNode:".allWidth",highlightMatchItem:!1,menu:{align:{overflow:{adjustY:0}}},cache:!0}},_prepareHtml:function(e){var r=this,o=n.get(e.node),a=o.innerHTML,i=e.prefixCls,u=n.get(e.placeholderEl),s=u?u.outerHTML:"",l='<div class="{cls}combobox"><div class="{cls}combobox-input-wrap"></div></div>',c=l.replace(/{cls}/g,i).replace(/{label}/g,s).replace(/{input}/g,a),f=n.create(c),g={"aria-haspopup":"true","aria-combobox":"list",role:"combobox",autocomplete:"off","class":i+"combobox-input","x-webkit-grammar":"builtin:translate"};return n.attr(o,"aria-label")||(g["aria-label"]=r._isOpen("history")?"请输入搜索文字或从搜索历史中选择":"请输入搜索文字"),n.attr(o,g),n.wrap(o,f),this.get("sugConfig").focused&&n.get(o).focus(),t.one("."+i+"combobox")},_isOpen:function(t){var r=this,n=r.get("mods"),o=n.sort;return e.inArray(t,o)},_getRenderMods:function(){var t=this,r=e.merge(a,t.get("mods"));t.set("mods",r)},_getDataSourceCfg:function(){var t=this,r=t.get("sugConfig"),n=t.get("dataSourceCfg"),o=r.sourceUrl;return location.href.indexOf("debug=test")>-1&&(o=o.replace("suggest.taobao.com/sug?","suggest.proxy.taobao.org/sug?")),-1===o.indexOf("bucketid")&&(o+="&bucketid="+t._getBucketId()),n.xhrCfg.url=o,n.parse=e.bind(t.parse,t),n},_getBucketId:function(){return(new i).getBucket()},_getComboCfg:function(r){var n=this,o=n.get("sugConfig"),a=n._getDefComboCfg(),i=o.prefixCls,u=t.one("."+i+"-combobox");return u||(u=n._prepareHtml(o)),a.srcNode=u,a.dataSource=r,a.format=e.bind(n.format,n),a.prefixCls=o.prefixCls,a.holderEl=t.one(o.placeholderEl),a.maxItemCount=a.maxItemCount||r.maxItemCount,a},_initCombo:function(){var e,t,r=this,n=r._getDataSourceCfg(),a=r.get("sugConfig");r._getRenderMods(),a.sourceUrl?(e=new o.RemoteDataSource(n),e.maxItemCount=10):(e=new o.LocalDataSource(n),e.maxItemCount=0),r._setComboCache(e),t=r._getComboCfg(e);var i=new o(t);i.render(),r.comboBox=i,r._checkHasTab(),r._initComboEvent()},update:function(t){for(var r=this,n=r.get("plugins"),o=0,a=n.length-1;a>=o;o++){var i=n[o];i&&e.isFunction(i.update)&&i.update.call(i,t)}},parse:function(t,r){var n,o=this,a=o.fire("beforeParse",{results:r,query:t});if(a===!1)return[[""]];if(a&&(r=a),!r||!r.result)return e.log("接口无数据!"),[[""]];n=r.result,delete r.result;var i=o.comboBox.get("dataSource");if((i.extraData||(i.extraData=[]))[t]=r,0===n.length)return[[""]];for(var u in n)n[u]||n.splice(u,1);return n},format:function(e,t){var r=this;return r.resultArr=[],r.render(e,t),r.resultArr},render:function(e,t){var r,n,o,a,i,u,s=this,l=s.get("mods"),c=l.sort,f=s._adjustExtra(e,l.showExtra);s.query=e;for(var g=0,d=c.length-1;d>=g;g++)if(u=c[g])if("list"!==u){if(i=s.getPlugin(u),i&&i.renderPlugin)i.renderPlugin({query:e,results:t});else if(n=l[u],n&&f&&(!(a=n.pos)||o!==a)){if(r=n.tmpl,!r)continue;var m=s.resultArr.length,p=s.diffLen||0;o=s.defaultRender({tmpl:r,name:u,pos:a,always:n.always&&t.length>0,callback:n.callback,index:m-p})}}else n=l[u],r=n.tmpl,s._list(e,t,r);s.fire("afterQueryChange",{query:e})},defaultRender:function(t){var r,n=this,o=t.tmpl,a=t.name,i=n.comboBox.get("dataSource"),u=n.query,s=n.get("sugConfig").prefixCls,l=i.extraData,c=t.pos,f=t.index;if(l&&l[u]||t.always){var g,d,m=n._getDate(),p={$query:u,$queryUrl:encodeURIComponent(u),$date:m,prefixCls:s};if(!t.always){if(g=l[u][a],d=!0,!g)return;if(e.isArray(g)){g.length>2&&(g.length=2);for(var h=0,v=g.length-1;v>=h;h++){var b=g[h];if(e.isArray(b)){d=!1;for(var C=0,x=b.length-1;x>=C;C++)p["$"+C]=b[C]||"";p.$index=f+1+h,r=e.substitute(o,p),n.addContent({html:r,query:u,position:c,callback:t.callback})}else p["$"+h]=b,p.$index=f+1+h}return d&&(r=e.substitute(o,p),n.addContent({html:r,query:u,position:c,callback:t.callback})),c}if(e.isObject(g)){for(var _ in g)p[a+"_"+_]=g[_];"active"===a&&(p.$query=g.query+" "+g.tag)}else p[a]=g,p.$query=g}return p.$index=f+1,r=e.substitute(o,p),n.addContent({html:r,query:p.$query||u,position:c,callback:t.callback}),c}},_adjustExtra:function(e,t){return""!==e?!0:!1},getNick:function(){var e=this;return e._getCookie("lgc")||e._getCookie("tracknick")},_getCookie:function(t){var r=window;if(r.userCookie&&!e.isUndefined(r.userCookie[t]))return r.userCookie[t];if(r.SRP_COOKIES||(r.SRP_COOKIES={})&&e.isUndefined(SRP_COOKIES[t])){var n=document.cookie.match("(?:^|;)\\s*"+t+"=([^;]*)");SRP_COOKIES[t]=n&&n[1]?decodeURIComponent(n[1]):""}return SRP_COOKIES[t]},_getDate:function(){var e=new Date;return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+(e.getDate()+1)},_list:function(t,r,n){var o,a=this,i=a.get("sugConfig").resultFormat,u=a.resultArr||(a.resultArr=[]);e.each(r,function(a,s){if(!a||!a[0])return void r.splice(s,1);var l,c=a[0],f="",g=t;if(c.match(/<b>/))o=c.replace(/<b>(\S+?)<\/b>/g,function(e,t){return t}),f=c,c="";else{for(;c.indexOf(g)<0;)g=g.substr(0,g.length-1);""===g?(f=c,c=""):0===c.indexOf(g)?(f=g,c=c.replace(g,"")):(f=c,c=""),o=a[0]}for(var d in u)if(l=u[d],l.textContent===a[0]&&l.unique)return;n=n.replace("{format}",i),u.push({textContent:o,content:e.substitute(n,{query:f,text:c,index:s+1,count:a[1],textContent:encodeURIComponent(o)}),list:!0})}),a.resultArr=u},addContent:function(e){var t=this,r=e.html,n=e.position,o=e.query;if(!n){var a=t.resultArr||[];return void a.push({content:r,textContent:o})}t["__"+n]={tmpl:r},t._addExtraEvent()},_renderHeader:function(e,r,n){var o=r&&r.type+"-header"||"";if(r){var a=this.get("sugConfig").prefixCls;e||(e=new t("<div class='"+a+"combobox-menu-header "+o+"'></div>").prependTo(n)),e.empty().append(r.tmpl)}else e&&e.remove()},_renderFooter:function(e,r,n){var o=this,a=o.get("sugConfig").prefixCls,i=r&&r.type+"-footer"||"";if(r){e||(e=new t("<div class='"+a+"combobox-menu-footer "+i+"'></div>").appendTo(n)),r.css&&e.css(r.css),e.empty().append(r.tmpl);var u=e.one("."+a+"menu-history-clean");u&&u.on("click",function(e){e.halt();var t=o.getPlugin("history");t._cleanHistory()})}else e&&e.remove()},_addExtraEvent:function(e){var t=this,r=t.comboBox||t,n=t.__header,o=t.__footer,a=t.__lastHeader,i=t.__lastFooter,u=t.get("sugConfig").prefixCls;if(!e||e&&!e.newVal){var s=r.get("menu");if(!s.get)return;var l=s.get("el");if(!l||l.all("."+u+"menuitem").length<1)return;var c=l.one("."+u+"combobox-menu-header"),f=l.one("."+u+"combobox-menu-footer");a!==n&&(t.__lastHeader=n,t._renderHeader(c,n,l)),i!==o&&(t.__lastFooter=o,t._renderFooter(f,o,l))}else t.__header=null,t.__footer=null}},{ATTRS:{sugConfig:{value:{extraPassParams:"",extraPostParams:"",sourceUrl:"",tab:"item",autoCollapsed:!0,focused:!1,prefixCls:"search-",excludeParam:["q"],resultFormat:"约{count}个宝贝"},setter:function(t){var r=this.get("sugConfig");return e.mix(r,t,void 0,void 0,!0)}},mods:{value:{},setter:function(e){return e}},input:{getter:function(e){return e||(e=this.comboBox.get("input"))}},form:{getter:function(e){return e||(e=this.get("input").parent("form"))}},label:{getter:function(e){return e||(e=this.comboBox.get("holderEl"))}},menu:{getter:function(e){return e||(e=this.comboBox.get("menu"))}},dataSourceCfg:{value:{xhrCfg:{url:"",dataType:"jsonp",scriptCharset:"utf-8",data:{code:"utf-8"}},allowEmpty:!0,paramName:"q",cache:!0}}}}));return l},{requires:["node","rich-base","dom","./suggest","./mods/mods","./mods/bts","./mods/utils","./mods/stat"]});