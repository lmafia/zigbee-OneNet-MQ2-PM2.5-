KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/config",function(a){var b=(a.getLogger("config"),{});return{set:function(c,d){return a.isObject(c)||!c?b=c||{}:void(b[c]=d)},get:function(c){c=c||"";var d=c.split("."),e="";return a.each(d,function(a,c){return e=0===c?b[a]:e[a],"undefined"==typeof e?!1:void 0}),e}}},{requires:[]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/utils",function(a,b,c){var d=(a.getLogger("utils"),-1===location.host.indexOf("daily.")),e=d?"taobao.com":"daily.taobao.net";return{isOnline:!d,tbDomain:e,cartUrlPre:"//cart."+e+"/",getToken:function(){return b.val("#_tb_token_")||b.val("#J_TokenField")||""},getTrackId:function(){return c.get("t")},parseItemUrl:function(b){if(b&&a.isString(b)&&(-1!==b.indexOf("item.")||-1!==b.indexOf("detail."))){var c;if(b.indexOf("id=")>-1?c=b.split("id=")[1]:b.indexOf("item_id=")>-1&&(c=b.split("item_id=")[1]),c){var d=c.split("&")[0];if(d)return{itemId:d,isChaoshi:b.indexOf("chaoshi.")>-1}}}},toYuan:function(a){return parseFloat(parseInt(a,10)/100).toFixed(2)},removePicSuffix:function(a){return a.replace(/_(sum|\d{2,5}x\d{2,5})\.jpg$/,"")}}},{requires:["dom","cookie"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/price/index-tpl",function(a,b){a.getLogger("price.tpl");return{generate:function(a){return'<dl class="tbc-sku-line tbc-sku-price clearfix"><dt>\u4ef7\u683c</dt><dd class="price"><span class="tbc-price">&yen;<em class="J_ItemPrice">'+b.toYuan(a.item.price)+"</em></span></dd></dl>"}}},{requires:["../../utils"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/price/index",function(a,b,c,d){function e(a,b,c){this.$container=a,this.render(b),c.on("skuChange",function(a){this.update(a)},this),c.on("amountChange",function(a){this.update(a)},this)}var f=(a.getLogger("price"),b.all);return e.prototype.update=function(a){a.item&&this.$price.html(d.toYuan(a.item.price))},e.prototype.render=function(a){this.$container.append(f(c.generate(a))),this.$price=f(".J_ItemPrice",this.$container)},e},{requires:["node","./index-tpl","../../utils"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/prop/index-tpl",function(a){function b(a,b,c){return a&&b[0]===a[c.replace(/&nbsp;/g,"").replace(/\s+/gi,"").replace(/\u3000/g,"")]}a.getLogger("sku.tpl");return{generate:function(c){var d="";return a.each(c.prop,function(e,f){d+='<dl class="tbc-sku-line tbc-sku-prop clearfix J_Prop"><dt>'+f+'</dt><dd><ul class="clearfix">',a.each(e,function(a,e){"pvId"!==e&&"type"!==e&&(d+='<li data-prop="'+f+'" data-pvid="'+e+'" class="prop-block J_PropBlock ',b(c.curSku,a,f)&&(d+="selected"),2===a.length&&(d+=" img-mode "),d+='" title="'+a[0]+'"><a href="javascript: void(0)" ',2===a.length&&(d+=' style="background:url('+a[1]+') 50% 50% no-repeat;" '),d+="><span>"+a[0]+"</span></a><i></i></li>")}),d+="</ul></dd></dl>"}),d}}},{requires:[]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/prop/index",function(a,b,c,d){function e(a,b,c){this.$container=a,this.data=b,this.skuInfo={prop:{},pvids:null},this.ec=c,this.render(b)}var f=(a.getLogger("prop"),b.all);return e.prototype.render=function(a){var b=this,e=this.$container.append(f(d.generate(a))),g=new c({root:e,hook:".J_PropBlock",skuMap:a.skuMap,attrName:"data-pvid",selectedClass:"selected",disabledClass:"disabled"});g.on("skuFound skuChanged",function(a){var c=a.sku;b.ec.fire("skuChange",c),b.selectedSku=c}),g.on("selectionChanged",function(a){b.ec.fire("skuSelectionChanged",a.sku)}),g.on("skuLost",function(){b.selectedSku=null}),g.init()},e.prototype.check=function(){var a=this;return a.selectedSku?a.selectedSku:{error:"\u8bf7\u9009\u62e9\u5546\u54c1\u5c5e\u6027"}},e},{requires:["node","tbc/sku/1.0.12/index","./index-tpl"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/amount/index-tpl",function(a){a.getLogger("amount.tpl");return{generate:function(a){return'<dl class="tbc-sku-line tbc-sku-amount clearfix"><dt>\u6570\u91cf</dt><dd class="clearfix"><div class="amount-wp"><a href="#" class="J_AmountOp J_Minus tbc-amount-minus no-minus"><span class="tbc-cart-iconfont">&#xe601;</span><span class="origin">-</span></a><input type="text" value="'+(a.quantity||1)+'" class="J_AmountInput amount-input" /><a href="#" class="J_AmountOp plus J_Plus  tbc-amount-plus"><span class="tbc-cart-iconfont">&#xe600;</span><span class="origin">+</span></a></div><span class="unit">\u4ef6</span><span class="stock">\uff08\u5e93\u5b58<em class="J_Stock" data-defstock="'+a.item.stock+'">'+a.item.stock+"</em>\u4ef6\uff09</span></dd></dl>"}}},{requires:[]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/amount/index",function(a,b,c){function d(a,b,c){this.ec=c,this.data=b,this.$container=a,this.render(b),this.ec.on("skuChange",function(a){this._updateStock(a),this._validateQuantity(a)},this)}var e=(a.getLogger("amount"),b.all);return d.prototype.getCurVal=function(){return parseInt(this.$input.val(),10)},d.prototype.render=function(a){this.$container.append(e(c.generate(a))),this.$stock=e(".J_Stock",this.$container),this.$input=e(".J_AmountInput",this.$container),this.$minusBtn=e(".J_Minus",this.$container),this.$plusBtn=e(".J_Plus",this.$container),this.$container.delegate("click",".J_Plus",function(a){a.preventDefault();var b=this.getCurVal();this.$plusBtn.hasClass("no-plus")||(this.$input.val(b+1),b>0&&this.$minusBtn.replaceClass("no-minus","minus"),this._validateQuantity())},this),this.$container.delegate("click",".J_Minus",function(a){if(a.preventDefault(),this.$minusBtn.hasClass("no-minus"))return!1;var b=this.getCurVal();return b>1&&this.$input.val(--b),2>b&&this.$minusBtn.replaceClass("minus","no-minus"),this._validateQuantity(),!0},this)},d.prototype._getCurrentStock=function(){return parseInt(this.$stock.text(),10)},d.prototype._updateStock=function(a){this.$stock.html(a.stock)},d.prototype.check=function(){var a=this,b=/^\d+$/,c=a.$input,d=a.getCurVal();if(!b.test(c.val()))return c.val(d||1),{error:"\u8bf7\u586b\u5199\u6b63\u786e\u7684\u5b9d\u8d1d\u6570\u91cf\uff01"};var e=a._getCurrentStock();if(!e)return{error:"\u6682\u65f6\u7f3a\u8d27"};if(d>e)return{error:"\u6700\u591a\u53ef\u8d2d\u4e70"+e+"\u4ef6\u5546\u54c1"};if(a.checkQuantity){var f=a.checkQuantity(d);if(f)return{error:f}}return{quantity:d}},d.prototype._validateQuantity=function(){var a=this.check();return a.error?this._showErrorInfo(a.error):!0},d.prototype._showErrorInfo=function(){},d},{requires:["node","./index-tpl"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/pic/index-tpl",function(a){a.getLogger("index.tpl");return{generate:function(a){return'<dl class="tbc-sku-line tbc-sku-pic"><dt>\u5b9d\u8d1d\u56fe\u7247</dt><dd><div class="tb-pic item-pic"><div class="wrapper"><img src="'+a.item.picUrl+'_160x160.jpg" class="J_ItemPic" /></div></div></dd></dl>'}}},{requires:[]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/pic/index",function(a,b,c,d){function e(a,b,c){this.$container=a,this.data=b,this.render(b),this.defaultImage=this.data.item.picUrl,c.on("skuSelectionChanged",function(a){this.update(a)},this)}var f=(a.getLogger("pic"),b.all);return e.prototype.render=function(a){this.$container.append(f(c.generate(a))),this.$img=f("img.J_ItemPic",this.$container)},e.prototype.update=function(b){var c=this,e="";if(b.props){var g=c.data.prop;a.each(b.props,function(a){if(a){var b=f(a),c=b.attr("data-prop"),d=b.attr("data-pvid");if(g[c]&&g[c][d]&&2===g[c][d].length)return e=g[c][d][1],!1}})}e=e||this.defaultImage,this.$img.attr("src",d.removePicSuffix(e)+"_160x160.jpg")},e},{requires:["node","./index-tpl","../../utils"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/sku/sku",function(a,b,c,d,e,f,g,h,i){function j(b){var c=this;a.mix(c,b),c.data={},c.hasSku=!1,c.mods={},c.ec=a.mix({},e.Target),a.isString(c.$container)&&(c.$container=k(c.$container)),c.autoload!==!1&&c.get(function(a,b){a?alert(a&&a.message?a.message:"\u7cfb\u7edf\u5f02\u5e38\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"):(c.render(),c._rendered&&c._rendered())})}SALE_NOT_FOUND="\u8be5\u5b9d\u8d1d\u5df2\u88ab\u4e0b\u67b6\u6216\u5220\u9664";var k=(a.getLogger("sku"),b.all);return j.prototype.get=function(b){var e=this;return c({url:"//tbskip."+d.tbDomain+"/json/item_sku.do",dataType:"jsonp",data:{item_num_id:e.itemId},jsonpCallback:"jsonpGetSkuInfo"+a.guid(),success:function(c){a.isPlainObject(c)&&c.success?(e.data=c,e.hasSku=!!c.prop,b&&b(null,c)):b&&b(new Error("\u83b7\u53d6\u5546\u54c1\u5c5e\u6027\u4fe1\u606f\u5931\u8d25\uff0c\u8be5\u5546\u54c1\u53ef\u80fd\u5df2\u7ecf\u4e0b\u67b6\u6216\u5220\u9664"))},error:function(){b&&b(new Error("\u83b7\u53d6\u5546\u54c1\u5c5e\u6027\u4fe1\u606f\u5931\u8d25"))},timeout:10,charset:"gbk"})},j.prototype.render=function(b){b=b||this.data;var c={Sku:g,Amount:h,Pic:i};if(a.each(c,function(a,b){this["has"+b]!==!1&&(this.mods[b.toLowerCase()]=new a(this.$container,this.data,this.ec))},this),!a.isEmptyObject(this.mods)){var d=k(this.btnTpl||'<dl class="tbc-sku-line tbc-sku-operate"><dt>\u64cd\u4f5c</dt><dd><a href="javascript:void(0);" class="add-cart J_AddCart"><span>\u786e\u5b9a</span></a><a href="javascript:void(0);" class="cancel J_Cancel"><span>\u53d6\u6d88</span></a></dd></dl>');this.$container.append(d).delegate("click",".J_Cancel",function(a){a.preventDefault(),this._cancel&&this._cancel()},this).delegate("click",".J_AddCart",function(a){a.preventDefault(),this._confirm&&this._confirm(this.check())},this)}},j.prototype.check=function(){var b={error:null};return a.each(this.mods,function(c){if(c&&c.check){var d=c.check();if(d.error)return b=d,!1;b=a.mix(b,d)}}),b},j},{requires:["node","ajax","../utils","event","./price/index","./prop/index","./amount/index","./pic/index"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/event-center",function(a,b){var c=b.all,d=c("body"),e={};return{broadcast:function(b,c){a.log("[global]:broadcast event:"+b),e[b]=c,d.fire(b,c)},listen:function(b,c){d.on(b,c),e[b]&&c.call(this,a.mix(e[b],{target:this,type:b}))},detach:function(a,b){d.detach(a,b)}}},{requires:["node"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/add",function(a,b,c){function d(){window.TB?window.TB&&!window.TB.AddCart&&(window.TB.AddCart={}):window.TB={AddCart:{}}}var e=a.getLogger("add"),f=b.cartUrlPre+"add_cart_tiny.htm",g=b.cartUrlPre+"top_cart_quantity.htm",h=!1;return{add:function(i,j){e.info("add to cart"),d();var k=b.getTrackId();if(!k){if(h)return j&&j(new Error("\u8ba4\u8bc1\u5931\u8d25\uff0c\u8bf7\u767b\u9646\u540e\u91cd\u8bd5"),{data:i});var l=arguments.callee,m=this;return e.info("no trackId, load miniCart api for it."),a.getScript(g+"?callback=&appid=5&t="+a.now(),{success:function(){l.call(m,i,j)}}),void(h=!0)}e.info("trackId is: %s",k);var n={item_id:i.itemId,sku_id:i.skuId||null,quantity:parseInt(a.trim(i.quantity),10),t:a.now(),ct:k,source:i.source||"",_tb_token_:b.getToken()};c.broadcast("beforeAddToCart",n);var o=f+"?"+a.param(n);e.info("call api to add to cart: %s",o),a.getScript(o,a.bind(function(){var b=this,d=a.clone(TB.AddCart.CartResult);if(e.info("add to cart callback data: ",d),TB.AddCart.CartResult=null,d){if(d.error){if("\u65e0\u6cd5\u6dfb\u52a0\u8d2d\u7269\u8f66,\u8bf7\u767b\u5f55\u540e\u91cd\u8bd5!"===d.error)return a.use("tbc/mini-login/2.2.0/",function(a,d){var e=new d({});e.on("close",function(){c.broadcast("addToCartError","\u65e0\u6cd5\u6dfb\u52a0\u8d2d\u7269\u8f66\uff0c\u8bf7\u767b\u5f55\u540e\u91cd\u8bd5"),j&&j(new Error("not login"),{data:i})}),e.show(function(){b.add(i)})}),!1;c.broadcast("addToCartError",{error:d.error,data:i})}else c.broadcast("addToCartSuccess",{result:d,data:i});return j&&j(d.error?new Error(d.error):null,{result:d,data:i})}},this))}}},{requires:["./utils","./event-center"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/tip",function(a,b,c){function d(a,b){var c="error"===b?"&#xe603;":"&#xe604;";return'<div class="tbc-cart-tip-content"><span class="tbc-cart-icon-'+b+'">'+c+"</span>"+a+"</div>"}var e,f=(a.getLogger("tip"),b.all,null);return{show:function(a,b){return a?(b=b||"success",a=d(a,b),e&&clearTimeout(e),f?(f.hide(),f.set("content",a)):f=new c({elCls:"tbc-cart-tips tbc-cart-tips-"+b,align:{points:["cc","cc"]},content:a}),f.show(),f.center(),e=setTimeout(function(){f.hide()},3e3),!0):!1},hide:function(){e&&clearTimeout(e),f&&f.hide()}}},{requires:["node","overlay"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/mods/selector",function(a,b,c,d,e,f,g,h){function i(b){var d=this;a.mix(d,b),h.hide(),d._initLoadingPopup(),d.$container=j('<div class="J_SelectorPopup tbc-add2cart-select-popup"></div>');var e=b.config.successTip?b.config.successTip:"\u6dfb\u52a0\u6210\u529f\uff01";new f({itemId:d.itemId,$container:d.$container,_rendered:function(){d._removeLoadingPopup();var b=a.trim(c.html(d.$container));""===b?g.add({itemId:d.itemId,quantity:1,triggerEl:d.triggerEl}):(d._initPopup(),d._bindEvents())},_cancel:function(){h.hide(),d.popup&&d.popup.destroy()},_confirm:function(b){b.error?h.show(b.error,"error"):g.add({itemId:d.itemId,quantity:b.quantity,skuId:b.skuId||null,triggerEl:d.triggerEl},function(b){b?h.show(a.isString(b)?b:b.message,"error"):(h.show(e),d.popup&&d.popup.hide())})}})}var j=(a.getLogger("selector"),b.all);return a.augment(i,{_initLoadingPopup:function(){this.loadingPopup=new d({containerCls:"g-cart-loading",elCls:"g-cart-loading",width:20,height:20,align:{node:this.triggerEl,points:["tl","tl"]}})},_removeLoadingPopup:function(){if(this.loadingPopup){var b=this.loadingPopup.container;a.isFunction(this.loadingPopup.get)&&(b=this.loadingPopup.get("el")),j(b).remove(),this.loadPopup=null}},_initPopup:function(){this.alignProp={points:["cc","cc"]},c.remove(".g-cart");var a=new d({containerCls:"g-cart",elCls:"g-cart",align:this.alignProp,closable:!0,closeAction:"destroy"});a.render(),j(a.get("contentEl")).html("").append(this.$container),j(".ks-overlay-close-x",j(a.get("el"))).html("&#xe602;"),a.show(),a.center(),this.popup=a},_bindEvents:function(){this.popup&&e.on(window,"resize",function(){this.popup.set("align",this.alignProp)},this)}}),i},{requires:["node","dom","overlay","event","./sku/sku","./add","./tip"]}),KISSY.add("tbc/add-to-cart/1.3.4/plugin/add2cart",function(a,b,c,d,e,f){function g(c,d){a.makeArray(arguments);if(c=c||b.get("body"),c=a.isString(c)?b.query(c):c,c.length)return void a.each(c,function(a){a=b.get(a),g(a,d)});switch(c=c.getDOMNode?c.getDOMNode():c,b.nodeName(c)){case"img":break;default:h(c,d)}}function h(a,d){var e={config:d};switch(parseInt(d.loadType,10)){case 2:c.on(a,"mousemove",function(a){var c=a.target;if(c&&"IMG"==c.nodeName&&!b.data(c,l))return b.hasClass(c,n)||b.hasClass(c,o)?void this._maskAsTriggered(c):void(e.config&&e.config.preventAll&&!b.hasClass(c,p)||this._initTrigger(c,a.config))});break;default:c.on(a,"click",function(a){var c=a.target;c&&!b.data(c,m)&&(b.hasClass(c,o)||b.hasClass(c.parentNode,o))&&(a.preventDefault(),i(c,d))})}}function i(a,b){if(k.info("[init] initSelector for node: ",a),a){var c="A"===a.nodeName?a:a.parentNode;if(c){var d=c.href,g=e.parseItemUrl(d);if(!g||!g.itemId)return void j(a,m);k.info("[init] new Selector, itemId: %s",g.itemId),new f({itemId:g.itemId,isChaoshi:g.isChaoshi,triggerEl:a,trackPointUrl:"//gm.mmstat.com/tbcart.2.2",config:b})}}}function j(a,c){k.info("[init] mark node as triggered",a,c),b.data(a,c||l,"1")}var k=a.getLogger("init"),l="cart-plugin-triggered",m="cart-plugin-click-triggered",n="J_CartPluginIgnore",o="J_CartPluginTrigger",p="J_CartPluginImg",q={};return q._initTrigger=function(a,c){if(util.log("[init] initTrigger for node: ",a),a){var d=b.parent(a,"a");if(!d||!d.href||b.hasClass(d,o))return void j(a);var e=d.href,f=this._validItemUrl(e);if(!f||!f.itemId)return void j(a);j(a),util.log("[init] new Trigger, itemId: %s, redirectUrl: %s",f.itemId,e),new Trigger({itemId:f.itemId,triggerEl:a,redirectUrl:e,config:c,trackPointUrl:"//gm.mmstat.com/tbcart.2.1"})}},q._validItemUrl=function(b){if(b&&a.isString(b)&&(-1!==b.indexOf("item.")||-1!==b.indexOf("detail."))){var c;if(b.indexOf("id=")>-1?c=b.split("id=")[1]:b.indexOf("item_id=")>-1&&(c=b.split("item_id=")[1]),c){var d=c.split("&")[0];if(d)return{itemId:d,isChaoshi:b.indexOf("chaoshi.")>-1}}}},function(a,b){b=d.set(b),g(a,b)}},{requires:["dom","event","./mods/config","./mods/utils","./mods/selector"]});