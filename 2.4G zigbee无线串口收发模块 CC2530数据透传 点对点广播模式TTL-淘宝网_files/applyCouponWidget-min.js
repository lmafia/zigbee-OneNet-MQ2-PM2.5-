KISSY.add("smf/coupon/apply",function(a,b){function c(a){this.config=a,this.type=a.type?a.type:"hongbao",this.activityId=a.activityId,this.showItems=void 0!=a.showItems?a.showItems:!0,this.sellerId=a.sellerId,this.daily=void 0!=a.daily?a.daily:!1,this.applyChannel=a.applyChannel,this.isShop=a.isShop?!0:!1,this.token=a.token?a.token:"";var b="taoquan.taobao.com";this.daily&&(b="taoquan.daily.taobao.net"),"hongbao"==this.type?(this.cburl=a.cburl,this.applyUrl=location.protocol+"//"+b+"/coupon/shopbonus/buyer_share_apply.htm"):this.applyUrl=location.protocol+"//"+b+"/coupon/itemCoupon/item_coupon_promotion_apply.htm",this.init()}var d=a.DOM,e=a.Event,f=function(a){return this instanceof f?(a=a||{},this.cburl=a.cburl,this.daily=!!a.daily,this.from=a.from,f.__INSTANCE__=this,this.available=!0,void this._init()):new f(a)};return a.augment(f,e.Target,{_init:function(){return a.namespace("Member.Weibo",!0),window.Member.Weibo.Bind=f,this.from&&this.cburl&&0===this.cburl.indexOf(window.location.protocol+"//"+window.location.host)?void(this.url=location.protocol+"//member1."+(this.daily?"daily.taobao.net":"taobao.com")+"/member/fresh/weibo_bind_management.htm"):(this.available=!1,this.fire("failure"),void alert("ERROR: no from/cburl param or domain not match."))},show:function(){return this.available?(this.o=new b.Dialog({prefixCls:"applyCoupon-",width:400,headerContent:"\u9886\u53d6\u7ea2\u5305\u9700\u8f6c\u53d1\u6d3b\u52a8\u5fae\u535a",bodyContent:'<iframe src="'+this.url+"?cburl="+this.cburl+"&from="+this.from+'" style="display:block;width:400px;height:355px;" scrolling="no" frameborder="0" allowtransparency="true"></iframe>',closable:!0,closeAction:"destroy",mask:!1,zIndex:1e9}),this.o.render(),this.o.center(),this.o.get("el").all(".applyCoupon-ext-close-x").html("\xd7"),this.o.show(),this._bindEvent(),this):this},hide:function(){return this.available?(this.o&&this.o.destroy(),this.o=null,this.fire("hide"),this):this},_bindEvent:function(){this.on("success failure",function(){this.hide()},this),this.o&&this.o.on("hide",function(){this.fire("hide"),this.fire("destroy")},this)}}),a.augment(c,e.Target,{init:function(){var a=!1;if(-1==window.location.href.indexOf("taobao"))a=!0;else{var b=function(a){var b,c;return(c=String(document.cookie).match(new RegExp("(?:^| )"+a+"(?:(?:=([^;]*))|;|$)")))&&(b=c[1]?decodeURIComponent(c[1]):""),b};a=!!(b("_l_g_")&&b("_nk_")||b("ck1")&&b("tracknick")||b("lgc"))}this.initLogin(a)},normalize:function(a){return a=this.daily?a.replace("assets.alicdn.com","assets.daily.taobao.net").replace("taobao.com","daily.taobao.net"):a.replace("assets.daily.taobao.net","assets.alicdn.com").replace("daily.taobao.net","taobao.com")},initLogin:function(a){0==a?this._doLogin():this._apply()},_doLogin:function(){var b=this;goldlog.send(location.protocol+"//ga.mmstat.com/tbtwlact.2.2",{});var c=b.normalize("//login.taobao.com/member/login.jhtml?style=mini&is_ignore=false&full_redirect=true"),f='<div class="sns-login-content"><div class="sns-login-wrap"><div class="sns-login-title">\u6dd8\u5b9d\u4f1a\u5458</div><iframe width="330" height="285" frameborder="0"scrolling="no" src="'+c+'&redirect_url={redirectUrl}"></iframe></div><s style="display:{closeBtn}" class="sns-close-btn">&times;</s></div>',g=".sns-close-btn {    color:#9c9c97;    text-decoration:none;    font-size:22px;    position:absolute;    right:12px;    top:5px;    cursor:pointer;}.sns-popup-login {	position:absolute;}.sns-login-content {   border-radius: 3px;	border:3px solid #d5d5d5;	background-color:#FAFAFA;}.sns-login-wrap {   width: 330px;    border: 1px solid #aaa;   overflow: hidden; }.sns-login-title {   background: #f2f2f2;   height: 35px;   line-height: 35px;   font-size: 14px;   font-weight: 700;   color: #000;   padding-left: 15px;   margin-bottom: 25px;}";d.addStyleSheet(g);var h=new a.Overlay({elCls:"sns-popup-login",content:a.substitute(f,{closeBtn:"block",redirectUrl:encodeURIComponent(window.location.href)}),zIndex:1e9,mask:!1,align:{node:null,points:["cc","cc"],offset:[0,0]}});h.render(),h.show();var i;i=a.isFunction(h.get)?h.get("el").getDOMNode():h.container,e.on(d.get(".sns-close-btn",i),"click",function(){h.destroy()})},_apply:function(){var a=this,b={activityId:a.activityId,sellerId:a.sellerId,applyChannel:a.applyChannel};a._doApply(b,function(b){if(a.shopUrl=b.shopUrl,a.shopName=b.shopName,a.amount=b.amount,a.startTime=b.startTime,a.endTime=b.endTime,a.startFee=b.startFee,a.discount=b.discount,a.activeCenter=b.activeCenter,"true"==b.success)a.renderPop(b);else switch(b.code){case"NOT_LOGIN":a.initLogin(!1);break;case"NOT_BIND_WEIBO":a.weiboBind();break;case"SHARE_WEIBO":a.share();break;case"PARAM_VALID":alert(b.msg);break;case"APPLY_ERROR":a.renderPop(b)}})},_doApply:function(b,c,d){a.io({url:this.applyUrl,data:b||{},cache:!1,dataType:"jsonp",success:function(a){c&&c(a)},error:function(){d?d():alert("\u9886\u5238\u5931\u8d25\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")}})},weiboBind:function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.3",{});var a=this;f({cburl:a.cburl,daily:a.daily,from:"sns"}).show().on("success",function(){a.share(),goldlog.send("//ga.mmstat.com/tbtwlact.2.8",{})}).on("failure",function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.8",{})})},_getValue:function(b){var c=a.trim(d.attr(b,"placeholder")),e=a.trim(b.value),f=d.attr(b,"maxlength");return c===e?"":f&&e>=f?e.substr(0,f):e},encodeGBK:function(a){function b(a){return a?window.ActiveXObject?(execScript('SetLocale "zh-cn"',"vbscript"),a.replace(/[\d\D]/g,function(a){return window.vbsval="",execScript('window.vbsval=Hex(Asc(" '+a+'"))',"vbscript"),"%"+window.vbsval.slice(0,2)+"%"+window.vbsval.slice(-2)})):(c.src="//go.mmstat.com/jsclick?globaljs=1&separator="+a,c.src.split("&separator=").pop()):""}var c=document.createElement("img");return a.replace(/([^\x00-\xff]+)|([\x00-\xff]+)/g,function(a,c,d){return b(c)+encodeURIComponent(d||"")})},share:function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.1",{});var c=this,d=a.Cookie.get("_nk_")||a.Cookie.get("lgc");void 0!=d&&(d=a.fromUnicode(d)),c.shopName||(c.shopName="");var e;e=c.amount?'<div class="apply-coupon-content clearfix"><div class="sns-content"><div class="article"><div class="selected"><span class="title">\u540c\u6b65\u5230:</span><i class="i-sina"></i></div><div class="item"><div class="share-ipt"><div class="user"><img src="//wwc.alicdn.com/avatar/getAvatar.do?userNick='+c.encodeGBK(d).toLowerCase()+'&width=80&height=80&type=sns" width="40" height="40"><span class="user-nick">'+d+'</span></div><div class="entry"><textarea maxlength="140" class="J_SnsShareComment">#1212\u5e97\u94fa\u7ea2\u5305\u5927\u6d3e\u9001#\u8f7b\u8f7b\u677e\u677e\u5c31\u9886\u5230'+c.amount+"\u5757\u94b1\uff0c\u597d\u55e8\u68ee\uff01\uff01\u4f60\u60f3\u8981\u5417\uff1f"+c.shopName+'\u5e97\u94fa\u6b63\u5728\u53d1\u7ea2\u5305\uff0c\u5c0f\u4f19\u4f34\u4eec\u90fd\u62a2\u75af\u4e86\uff0c\u518d\u4e0d\u53bb\u5c31\u6ca1\u5566\uff01</textarea></div><p class="count hidden">\u8fd8\u53ef\u4ee5\u8f93\u5165 <em class="J_Count">135</em> \u4e2a\u5b57</p><s></s></div></div></div><div class="sns-share-widget-footer"><div class="operate"><a class="continue J_Continue J_Submit" href="">\u7acb\u5373\u5206\u4eab</a><a class="cancel J_Cancel J_Close" href="">\u53d6\u6d88</a></div><div class="J_ExtraInfo extra-info"></div></div></div></div>':'<div class="apply-coupon-content clearfix"><div class="sns-content"><div class="article"><div class="selected"><span class="title">\u540c\u6b65\u5230:</span><i class="i-sina"></i></div><div class="item"><div class="share-ipt"><div class="user"><img src="//wwc.alicdn.com/avatar/getAvatar.do?userNick='+c.encodeGBK(d).toLowerCase()+'&width=80&height=80&type=sns" width="40" height="40"><span class="user-nick">'+d+'</span></div><div class="entry"><textarea maxlength="140" class="J_SnsShareComment">#1212\u5e97\u94fa\u7ea2\u5305\u5927\u6d3e\u9001#\u8f7b\u8f7b\u677e\u677e\u5c31\u9886\u5230\u7ea2\u5305\uff0c\u597d\u55e8\u68ee\uff01\uff01\u4f60\u60f3\u8981\u5417\uff1f'+c.shopName+'\u5e97\u94fa\u6b63\u5728\u53d1\u7ea2\u5305\uff0c\u5c0f\u4f19\u4f34\u4eec\u90fd\u62a2\u75af\u4e86\uff0c\u518d\u4e0d\u53bb\u5c31\u6ca1\u5566\uff01</textarea></div><p class="count hidden">\u8fd8\u53ef\u4ee5\u8f93\u5165 <em class="J_Count">135</em> \u4e2a\u5b57</p><s></s></div></div></div><div class="sns-share-widget-footer"><div class="operate"><a class="continue J_Continue J_Submit" href="">\u7acb\u5373\u5206\u4eab</a><a class="cancel J_Cancel J_Close" href="">\u53d6\u6d88</a></div><div class="J_ExtraInfo extra-info"></div></div></div></div>';var f=new b.Dialog({prefixCls:"applyCoupon-",zIndex:1e9,mask:!1,headerContent:"\u9886\u53d6\u7ea2\u5305\u9700\u8f6c\u53d1\u6d3b\u52a8\u5fae\u535a",bodyContent:e,closeable:!0,closeAction:"destroy"});f.render();var g=f.get("el");g.all(".applyCoupon-ext-close-x").html("\xd7"),f.center(),f.show(),g.one("textarea").on("focus",function(b){a.all(b.target).css("color","#000")}).on("blur",function(b){a.all(b.target).css("color","#999")}),c._maxlength(g.getDOMNode()),g.one(".J_Close").on("click",function(a){a.preventDefault(),goldlog.send("//ga.mmstat.com/tbtwlact.2.7",{}),f.destroy()}),g.one(".applyCoupon-ext-close-x").on("click",function(){goldlog.send("//ga.mmstat.com/tbtwlact.2.7",{})}),g.one(".J_Submit").on("click",function(a){a.preventDefault(),goldlog.send("//ga.mmstat.com/tbtwlact.2.6",{});var b={activityId:c.activityId,sellerId:c.sellerId,applyChannel:c.applyChannel,title:encodeURIComponent("\u6dd8\u5b9d\u7f51\u53cc\u5341\u4e8c\u5e97\u94fa\u7ea2\u5305\u6d3b\u52a8"),comment:encodeURIComponent(c._getValue(g.all(".J_SnsShareComment").getDOMNode())),link:c.activeCenter};c._doApply(b,function(a){if(f.destroy(),"true"==a.success)goldlog.send("//ga.mmstat.com/tbtwlact.2.5",{activityId:c.activityId,sellerId:c.sellerId,applyChannel:c.applyChannel}),c.renderPop(a);else switch(a.code){case"PARAM_VALID":alert(a.msg);break;case"APPLY_ERROR":c.renderPop(a)}})})},hasParam:function(a){return a.indexOf("?")>-1?a+"&":a+"?"},_maxlength:function(a){var b="maxLength"in document.createElement("textarea");if(!b){var c=a.getAttribute("maxlength");e.on(a,"valuechange",function(){a.value.length>c&&(a.value=a.value.substring(0,c))})}},renderPop:function(c){var f=this,g="",h="",i='<div style="margin-top: 13px;color: #666;"><a class="J_close">\u786e \u5b9a</a>',j="",k="";"hongbao"==f.type?(k="1223.1.10",goldlog.send("//ga.mmstat.com/tbtwlact.1.1",{})):(k="1223.2.10",goldlog.send("//ga.mmstat.com/tbtwlact.3.1",{}));var l='<div class="applyCouponResult"><div class="close">\xd7</div> <div class="results">';if("true"==c.success){goldlog.send("//ga.mmstat.com/shopcoupons.1.* ",{});var m=!1;j='<div class="label suc"></div>',c.startTime=c.startTime.slice(0,10).replace("-",".").replace("-","."),c.endTime=c.endTime.slice(0,10).replace("-",".").replace("-",".");var n="";"hongbao"==f.type?(c.amount&&(n='<span class="red"><span class="money">\uffe5</span>'+c.amount+"</span>"),g="\u606d\u559c\uff0c\u60a8\u5df2\u6210\u529f\u9886\u53d6"+n+'\u5e97\u94fa\u7ea2\u5305\u3002<a target="_blank" href="//taoquan.taobao.com/framework/got_bonus.htm?scm=1223.1.10.1&tabIndex=5" style="font-size: 12px">\u67e5\u770b></a></div><div class="date">\u4f7f\u7528\u65f6\u95f4\uff1a'+c.startTime+"-"+c.endTime+" \u5168\u5e97\u901a\u7528</div>",h=""):(c.startFee&&c.discount&&(n='<span class="red">\u6ee1'+c.startFee+"\u51cf"+c.discount+"\u5143</span>"),g="\u606d\u559c\uff0c\u60a8\u5df2\u6210\u529f\u9886\u53d6"+n+'\u4f18\u60e0\u5238\u3002</div><div class="date">\u4f7f\u7528\u65f6\u95f4\uff1a'+c.startTime+"-"+c.endTime,g+="</div>"),m&&(i+='<span style="*vertical-align: bottom"><input checked="checked" class="J_collect" type="checkbox">\u6536\u85cf\u8be5\u5e97</span>'),f.fire("success",c)}else goldlog.send("//ga.mmstat.com/shopcoupons.2.* ",{}),j='<div class="label fail"></div>',g=c.msg+"</div>","hongbao"==f.type&&(h='<a target="_blank" href="//taoquan.taobao.com/framework/got_bonus.htm?scm=1223.1.10.1&tabIndex=5" style="font-size: 12px">\u67e5\u770b\u5df2\u9886\u5230\u7684\u5e97\u94fa\u7ea2\u5305></a>'),f.fire("fail",c);i+="</div>","hongbao"!=f.type&&(!f.isShop&&c.activeCenter&&(g+='<div><a href="'+f.hasParam(c.activeCenter)+"scm="+k+'.1" target="_blank">\u67e5\u770b\u8be5\u5e97\u66f4\u591a\u4f18\u60e0</a></div>'),h=' <div>\u67e5\u770b\u5df2\u9886\u4f18\u60e0\u5238\uff1a<a href="//taoquan.taobao.com/framework/got_bonus.htm?tabIndex=1&display=true&tabDomId=itemCouponTab&scm='+k+'.2" target="_blank">\u6211\u7684\u4f18\u60e0\u4fe1\u606f</a></div>'),l+=j+'<div class="result-text"><div class="result">'+g+'<div class="gray">'+h+"</div>"+i+"</div> </div> ",l+="</div>";var o=new b.Popup({prefixCls:"applyCoupon-",zIndex:1e9,mask:!1,content:l,closeable:!0,closeAction:"destroy"});o.render(),o.center(),o.show(),e.on(d.get(".close",o.get("el")),"click",function(){o.destroy()}),e.on(d.get(".J_close",o.get("el")),"click",function(){var b=d.get(".J_collect",o.get("el"));if(b&&d.prop(b,"checked")){var e;e=f.daily?"//favorite.daily.taobao.net/json/addCollectionForAll.htm":"//favorite.taobao.com/json/addCollectionForAll.htm",a.io({url:e,data:{shopId:c.shopId,favType:0},dataType:"jsonp",cache:"false"})}o.destroy()})}}),c},{requires:["overlay"]});